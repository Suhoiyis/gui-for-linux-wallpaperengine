# 更新日志

## 最新更新 (尚未提交版号)

- **UI 优化 (UI Optimization)**：
  - **预览图尺寸修复**：修复了大尺寸壁纸预览可能撑开布局的问题。通过实施严格的 `Gtk.ScrolledWindow` 约束并为 `AnimatedPreview` 启用缩小功能，确保所有缩略图无论源分辨率如何，都能保持一致的固定尺寸（200x200 / 280x280）。
- **侧边栏优化 (Sidebar Optimization)**：
  - **代码重构**：将主窗口侧边栏迁移至全新的 `AnimatedPreview` 组件，实现了与紧凑模式（Compact Mode）统一的图像渲染逻辑，并移除了冗余代码。
- **紧凑模式改进 (Compact Mode Improvements)**：
  - **重构与性能优化**：
    - 将 GIF 动画逻辑提取到独立的 `AnimatedPreview` 组件中，提高代码复用性
    - 为缩略图栏实现了 **对象池 (Object Pooling)** 技术，彻底消除了滚动过程中的界面闪烁和卡顿感
  - **多显示器支持增强**：
    - 在导航栏新增 **目标屏幕选择器**（显示器图标按钮）
    - 所有操作（应用、停止、跳转）现在均针对选定的特定显示器生效
    - 切换显示器时，预览图会自动同步为该屏幕当前正在运行的壁纸
- **重启逻辑修复 (Restart Logic Fix)**：修复了从 GUI（通过顶栏按钮）重启应用时，如果最初是带 `--hidden` 参数启动的，重启后仍会以静默/隐藏模式启动的问题。现在重启时会显式过滤掉隐藏标志，以确保窗口重新出现。

---

## v0.10.0 (2026-02-08)

### 全新功能
- **紧凑预览模式 (Compact Mode)**：
  - 专为 **平铺窗口管理器** (Niri, Hyprland, Sway) 设计的独立迷你窗口模式
  - **双窗口架构**：与主窗口分离，互斥显示，解决平铺布局下主窗口过宽的问题
  - **精简布局**：默认尺寸 **300x740**，专注于壁纸预览与快速切换
  - **核心交互**：
    - 顶部大图预览（支持 GIF 动画播放）
    - 底部 **5 缩略图循环导航**，支持首尾相接无限滚动
    - 键盘 `←` `→` 快捷键切换，界面两侧提供显式导航按钮
  - **信息展示**：保留关键信息（标题、大小、序号），采用经典的 **蓝色胶囊 ID** 样式（支持点击复制）
  - **功能完整**：包含应用壁纸、停止、手气不错 (Lucky)、跳转当前壁纸 (Jump) 等核心功能

### 改进
- **Wayland 兼容性**：修复了在 Wayland (Niri) 环境下重启应用后窗口可能不可见的问题
- **视觉优化**：全面调整了小窗模式的控件尺寸（缩略图 40px，按钮 30px），最大程度节省屏幕空间
- **配置集成**：在高级文档中增加了针对 Niri 和 Hyprland 的窗口规则配置指南

---

## v0.9.2 (2026-02-07)

### 新功能
- **截图历史记录**：在 Performance 页面新增截图历史面板，记录最近 10 次截图的详细信息（时间、壁纸、耗时、CPU/内存峰值）。支持查看缩略图，一键打开截图文件或所在文件夹，并提供清除历史记录功能
- **截图体验增强**：截图成功后的弹窗现在会显示对应壁纸的缩略图，并将“打开图片”设为默认推荐操作，字体和布局也进行了优化，更加美观易读

### 改进
- **监控布局重构**：将 Performance 页面顶部的全局线程列表拆分，分别整合到 Process Details 下各自的进程卡片中。每个进程现在都有独立的 "Thread Details" 下拉抽屉，并为所有抽屉添加了精致的边框样式，使界面结构更清晰、逻辑更内聚
- **线程命名优化**：优化了 Performance 页面的线程列表显示。将内部监控线程显式命名为 "PerfMonitor"，避免显示系统自动生成的截断名称（如 "Thread-1(_moni..."）；同时保留了对后端引擎截断线程名（如 "linux-w:disk$0"）的智能还原，提升了可读性
- **滚动条样式优化**：滚动条改为更细的 3px 宽度、半透明白色，并添加淡入淡出过渡动画，视觉更优雅低调

### Bug 修复
- **图标显示**：修复了应用在 Dock/任务栏中显示默认图标的问题。通过将 `pic/` 目录注册到图标主题、设置程序运行名（prgname）以及优化 `.desktop` 文件生成逻辑（增加 `StartupWMClass` 并同步 ID 命名），实现了窗口与自定义图标的完美关联
- **历史记录刷新**：修复了截图历史记录超过 10 条后，新截图无法在列表中实时刷新的问题
- **CPU 监控**：修复了在 Xvfb 环境下快速截图（如视频壁纸）时，因进程生命周期过短导致 CPU 占用率无法被采集（显示 0%）的问题
- **性能监控**：修复了 CPU 占用率显示过高的问题。之前显示的是单核占用率（可能超过100%），现在已标准化为全系统总占用率（0-100%），与系统监视器（如 GNOME System Monitor）保持一致
- **配置保存**：修复了保存 Workshop 路径和 Autostart 设置时因方法名错误导致的程序崩溃。现在修改路径或切换自启选项时不再报错，且无需重启即可生效

---

## v0.9.1 (2026-02-07)

### 新功能
- **日志过滤**：Settings 页面的日志查看器新增过滤器，可按 "All", "Controller", "Engine", "GUI" 分类查看，方便快速定位问题
- **UI 优化**：~~在右侧壁纸详情栏新增红色的 "Stop Wallpaper" 按钮，方便快速停止当前屏幕的壁纸~~-----已取消

### Bug 修复
- **系统集成**：修复了在设置页面点击 "Create Desktop Shortcut" 时因方法缺失导致的崩溃问题。现在可以正常创建或更新桌面快捷方式

### 改进
- **Performance 页面**：优化了截图历史记录面板的布局，减小了标题与说明文字的行距，使界面更紧凑；移除了 Clear 按钮的扁平化样式，增加边框使其更显眼
- **弹窗体验**：统一优化了所有弹窗的字体大小和布局，提升可读性
- **日志管理**：优化了日志刷新机制，切换过滤条件时会自动刷新视图
- **复制功能**：Copy Logs 按钮现在仅复制当前过滤视图下的日志内容，方便精准分享调试信息

---

## v0.9.0 (2026-02-06)

### 新功能
- **性能监控页面**：全新的 System Monitor 页面，实时监控壁纸引擎资源占用
  - **总览卡片**：显示 Total CPU、Total Memory、Active Threads 三项核心指标
  - **历史曲线图**：基于 Cairo 的 Sparkline 组件，显示最近 60 秒的 CPU/内存变化趋势
  - **进程详情**：分别显示 Frontend（GUI）、Backend（渲染引擎）、Tray（托盘）三个进程的独立指标
  - **动态着色**：CPU 占用根据负载自动变色（绿色 <20%、橙色 <40%、红色 ≥40%），内存使用蓝色
  - **线程列表**：可展开查看各进程的详细线程名称（3列布局）
  - **壁纸详情**：Backend 进程可展开显示当前各显示器运行的壁纸缩略图、标题和 ID

### 改进
- **壁纸管理**：新增 `WallpaperManager.get_wallpaper()` 方法，支持按 ID 快速查询壁纸信息

### Bug 修复
- **Tray 监控稳定性**：修复切换壁纸时 Tray 进程从监控列表消失的问题

---

## v0.8.11 (2026-02-03)

### 新功能
- **顺序壁纸轮换**：壁纸自动切换现在支持多种顺序模式。除了默认的“随机”外，还可以选择按照 **标题 (Title)**、**文件大小 (Size)**、**类型 (Type)** 或 **文件夹ID (ID)** 的顺序进行循环播放。你可以在 `Settings > Automation` 中找到新的 "Cycle Order" 选项。

### Bug 修复
- **配置稳定性增强**：修复了在壁纸循环切换过程中，静音设置 (`silence`) 可能因配置读取异常而失效的问题。增加了对配置值的严格类型检查和默认值回退机制。
- **日志诊断**：增强了壁纸切换控制器的调试日志，现在可以详细追踪音频模式和属性应用状态。

---

## v0.8.10 (2026-02-02)

### 新功能
- **Wayland 高级控制 (P3-15)**：
  - 新增 **Wayland Tweaks** 设置面板，自动检测当前会话类型
  - 支持 **仅活动时暂停** (`--fullscreen-pause-only-active`)：仅当全屏窗口处于前台焦点时才暂停壁纸
  - 支持 **忽略应用列表** (`--fullscreen-pause-ignore-appid`)：可指定不触发暂停的应用程序 ID（如 Dock、Bar），解决部分桌面环境下壁纸误暂停的问题

---

## v0.8.9 (2026-02-02)

### 界面现代化 (UI/UX)
- **原生图标替换**：全面将界面中的 Emoji 图标替换为 GTK 标准符号图标 (Adwaita Symbolic Icons)，提升了在不同 Linux 发行版上的显示一致性和美观度
- **列表视图重构**：
  - 重新设计了壁纸列表项布局，增加了 **文件大小** 和 **序号/总数** 显示
  - 优化了信息层级和配色方案（Tags紫色、Index黄色、Size绿色），移除多余的胶囊背景，使界面更清爽
- **视觉一致性**：统一了顶栏和侧边栏的状态显示样式

---

## v0.8.8 (2026-02-02)

### 开发工具
- **应用内重启**：在顶栏最右侧新增 🔄 重启按钮，点击可快速重启 GUI 应用，方便应用开发迭代和配置重载

### UI 优化
- **计数器样式**：优化顶栏壁纸计数器的显示，改为醒目的纯黄色文字，移除多余背景框

---

## v0.8.7 (2026-02-01)

### 体验修复
- **截图目标修正**：修复了截图按钮错误地截取"当前预览壁纸"的问题。现在点击截图将严格截取"当前屏幕正在播放"的壁纸效果，符合所见即所得的操作逻辑。如果当前屏幕未运行壁纸，会弹出提示。

---

## v0.8.6 (2026-02-01)

### 视觉体验升级
- **动态预览 (P2-2)**：右侧栏详情页现在支持播放 GIF 动图！选中 GIF 壁纸时，预览图会自动播放，而非静止不动
  - *技术注记*：实现了基于 `GdkPixbufAnimation` 的手动帧调度器，解决了部分 GTK4 环境下直接加载 GIF 导致的白屏/Paintable 断言错误
- **智能缩略图 (P3-13)**：左侧壁纸列表的 GIF 缩略图现在会自动抓取第 15 帧，有效避免了开头黑屏或淡入前的空白画面
- **高质量缩放**：使用 LANCZOS 算法生成更清晰的缩略图

### UI 修复
- **Apply 按钮自适应**：修复了在单屏或双屏模式下错误显示高级应用菜单（下拉抽屉）的问题。现在仅在屏幕数量 >= 3 且处于 Diff 模式时才显示拆分按钮，简化操作逻辑。

---

## v0.8.4 (2026-02-01)

### 新功能
- **多显示器控制增强**：
  - **Link/Unlink 模式**：顶栏新增 🔗 切换按钮，可一键将壁纸应用到所有屏幕（Same 模式）或仅当前屏幕（Diff 模式）
  - **高级应用菜单**：侧边栏 Apply 按钮升级为拆分按钮，点击下拉箭头可手动勾选要应用的特定屏幕（支持 2+1 等复杂场景）

---

## v0.8.3 (2026-01-31)

### 新功能
- **壁纸计数器**：在 "CURRENTLY USING" 标题栏右侧显示当前壁纸序号/总数（N/M），使用醒目的样式与壁纸名字颜色一致
- **侧边栏序号显示**：在右侧栏 Folder ID 和 Size 旁边显示选中壁纸的序号/总数（N/M），黄色标签样式
- **实时更新**：计数器会在壁纸切换、屏幕切换、搜索/排序/重新加载时自动更新

### UI 改进
- **标签间距优化**：统一了 Folder ID、Size 和 Index 标签的间距，去除多余空隙

---

## v0.8.2 (2026-01-30)

### 新功能
- **命令复制**：在 "CURRENTLY USING" 旁边新增 📋 按钮，悬停显示当前运行的后端命令，点击复制到剪贴板

### UI 改进
- **系统标题栏支持**：使用 `Gtk.ApplicationWindow` 替代 `Adw.ApplicationWindow`，标题栏由窗口管理器绘制（GNOME/KDE 显示标题栏，niri/Hyprland 不显示）
- **屏幕选择器移至顶栏**：🖥 屏幕选择器从工具栏移至窗口左上角，与 Home/Settings 按钮同排

### Bug 修复
- **托盘随机切换修复**：修复了窗口隐藏时，使用托盘"随机切换壁纸"功能会意外唤出 GUI 窗口的问题

### 壁纸大小显示
- **侧边栏显示磁盘占用**：选中壁纸时，在 Folder ID 旁边显示壁纸文件夹的磁盘大小（如 "85.1 MB"）
- **绿色标签样式**：大小信息使用绿色胶囊标签，与蓝色的 Folder ID 形成对比

### 壁纸排序功能
- **工具栏排序控件**：新增 ⇅ 排序下拉菜单，支持 5 种排序方式
- **排序选项**：
  - Title - 按壁纸标题 A-Z 排序
  - Size ↓ - 按文件大小从大到小排序
  - Size ↑ - 按文件大小从小到大排序
  - Type - 按壁纸类型（Video/Scene/Web）排序
  - ID - 按文件夹 ID 排序（原默认方式）
- **配置持久化**：排序选项自动保存，重启后保持

---

## v0.8.1 (2026-01-25)

### 用户友好的错误反馈系统
- **Toast 通知系统**：新增 `Adw.ToastOverlay` 支持即时通知，用户无需查看日志即可了解问题
- **路径验证反馈**：设置页面保存时，如果 Workshop/Assets 路径无效，立即显示 Toast 提示
- **扫描错误检测**：壁纸扫描时检测路径不存在、目录为空、JSON 解析失败等问题，并提供友好提示
- **后端启动失败**：壁纸引擎启动失败时，自动显示错误提示，引导用户查看日志获取详细信息

### 新增 Assets 路径配置
- **自定义 Assets 目录**：在设置 > 高级中可手动指定 Wallpaper Engine assets 文件夹路径
- **Browse 按钮**：为 Workshop 和 Assets 路径都添加了文件夹浏览按钮，避免手动输入错误
- **路径验证**：保存设置时验证路径存在性，无效路径会自动清除配置并提示用户

---

## v0.8.0 (2026-01-24)

### 截图功能大修
- **真·静默截图**：智能检测并利用 `Xvfb` 实现无窗口后台截图（支持开关切换）
- **真·4K 采样**：强制后端以 3840x2160 分辨率渲染，完美解决平铺窗口管理器（如 Niri）下的画面裁切问题
- **交互闭环**：截图按钮实时状态反馈（📸 -> ⏳），成功后提供"打开图片/文件夹"快捷入口
- **智能策略**：针对视频壁纸启用极速模式（5帧），针对 Web 壁纸自适应延长等待时间

### 多显示器支持（Beta）
- **独立控制**：在主界面顶栏选择目标显示器，分别为不同屏幕设置不同壁纸
- **状态自愈**：启动时自动检测屏幕连接状态，智能清理已断开屏幕的配置，防止后端报错
- **全局管理**：托盘菜单的"随机播放"和"停止"操作会自动作用于所有活跃屏幕

### 自动化与体验升级
- **定时轮换**：支持按分钟间隔自动随机切换壁纸（支持多屏）
- **智能保存**：Settings 页面实现变更检测，修改非渲染参数（如自启、路径）时不再强制重启壁纸
- **系统集成**：一键生成桌面快捷方式 (`.desktop`) 和开机自启配置

### 高级渲染与音频控制
- **视觉管理**：新增禁用视差效果（Parallax）、禁用粒子系统（Particles）开关，以及纹理钳制（Clamping）模式选择
- **音频增强**：新增禁用自动静音（Auto Mute）、禁用音频处理逻辑（Audio Processing）开关

## v0.7.0 (早期版本)

### 系统托盘图标
- 基于 `libayatana-appindicator` 实现，完美支持 Wayland (Niri/Sway/Hyprland) + Waybar 环境

### 代码重构
- 将单文件脚本拆分为模块化包结构 (`py_GUI/`)，分离逻辑与界面
- 更名项目包为 `py_GUI`，新增启动脚本 `run_gui.py`

### 性能优化
- 改进了图片资源的加载与缓存机制

### 稳定性修复
- 修复了子进程输出导致的死锁问题，现在日志将重定向到文件而非管道

### UI 精简与交互优化
- **隐藏失效属性栏**：鉴于 C++ 后端在 Wayland 环境下的局限性（Web/Scene 属性无法生效），暂时禁用了侧边栏 Properties 编辑区，提升了界面整洁度并避免功能误导（代码已注释保留）
- **样式统一**：壁纸显示类型（Type）现在使用与标签一致的胶囊（Capsule）样式，视觉体验更统一

## v0.5.0

### 日志面板
- **实时日志显示**：应用和壁纸引擎的日志实时显示
- **日志级别**：支持 DEBUG/INFO/WARNING/ERROR 级别
- **日志来源**：区分 Controller/Engine/GUI 来源
- **日志管理**：Clear/Refresh 按钮，自动限制最大500条
- **等宽字体**：便于阅读日志内容
- **颜色区分**：不同日志级别使用不同颜色
- **一键复制**：Copy Logs 按钮可将日志内容复制到系统剪贴板

## v0.3.0

### 后台/CLI 控制
- **后台启动**：支持 `--hidden/--minimized` 启动参数，启动后仅后台运行，无窗口显示
- **单实例 CLI 控制**：所有命令行动作发往同一运行实例（复用 GTK 主线程，避免多开）
- **显示/隐藏窗口**：
  - `--show`：显示窗口（若已运行则展示）
  - `--hide`：隐藏窗口（进程保持）
  - `--toggle`：切换显示/隐藏状态
- **快捷操作**：
  - `--refresh`：重新扫描并加载壁纸库
  - `--apply-last`：直接应用上次保存的壁纸
  - `--quit`：完全退出应用与后台进程

### 搜索功能
- **实时搜索**：顶部搜索框支持按关键词实时过滤壁纸
- **多字段匹配**：搜索范围包括标题、描述、标签、文件夹名称

### 壁纸属性编辑（暂时禁用）
- **功能保留但已隐藏**：由于后端环境限制，目前在侧边栏已隐藏此区域。底层逻辑仍保留

## 早期版本功能

### 核心功能
- 壁纸浏览：从 Steam Workshop 自动扫描壁纸库
- 双视图模式：Grid（网格）与 List（列表）视图切换
- 侧边栏详情：显示壁纸大图、标题、类型、标签、描述
- 壁纸应用：点击 Apply 按钮或双击卡片直接应用壁纸
- 右键菜单：支持应用、停止、删除壁纸及打开所在文件夹
- 随机选择：I'm feeling lucky 随机应用一张壁纸
- 快速刷新：Refresh 按钮即时加载新下载的壁纸（无需重启）
- 自动应用：启动时自动应用上次壁纸

### 进程管理
- 后端调用：正确使用 `linux-wallpaperengine` 的参数格式
- 单实例控制：应用前自动 pkill 旧进程，避免堆叠
- 参数整数化：音量严格传递为整数字符串，防止浮点数崩溃

### UI/UX
- 现代深色主题：圆角、阴影、悬停效果
- 窗口约束：侧边栏固定 320px 宽度，不被图片撑宽
- 当前壁纸显示：顶部工具栏显示当前应用的壁纸名称
- 右键菜单优化：跟随鼠标位置弹出，支持点选或"按住-拖动-松手"的快速操作
- Stop 按钮：快速停止当前壁纸播放
- 后台保活窗口隐藏：关闭窗口会隐藏到后台（进程保留）
