# 壁纸兼容性指南
[English](COMPATIBILITY.md)

本文档详细说明了 Linux Wallpaper Engine GUI 在不同环境下的兼容性与限制。

## 后端架构

本 GUI 依赖 `linux-wallpaperengine` C++ 后端进行渲染。该后端是通过逆向工程实现的（并非官方移植版本），由于 Linux 图形栈（尤其是 Wayland）与 Windows 存在根本差异，某些壁纸可能无法完美显示。

## 壁纸类型兼容性

### ✅ 视频壁纸 (.mp4, .webm)

**兼容性**：完全支持

**备注**：
- 视频解码使用成熟的 FFmpeg/GStreamer 库
- 支持循环播放和音量控制
- 性能最优，资源占用最低
- **建议优先选择视频类型壁纸**

**测试环境**：
- ✅ X11 (GNOME/KDE)
- ✅ Wayland (Niri/Sway/Hyprland)

---

### ⚠️ Web 壁纸 (.html)

**兼容性**：部分支持

**可用功能**：
- ✅ 基础渲染：显示网页内容和动画
- ✅ JavaScript 执行：动态效果正常运行
- ✅ 音频播放：背景音乐播放（受音量控制影响）

**已知问题**：
- ❌ **属性调节功能失效**：由于 Linux/Wayland 下 C++ 后端中 CEF (Chromium Embedded Framework) 的通信限制，**Web 壁纸属性无法通过 GUI/CLI 进行动态调节**。
  - 示例：语言切换、音乐开关、颜色选择、实时数值更改等。
  - Windows 版本中可调节的大多数属性在 Linux 上实际上都无法使用。
  - 壁纸将以其默认属性值运行。

**技术原因**：
- CEF 的 IPC（进程间通信）实现在 Linux 和 Windows 之间存在差异。
- 后端尝试注入 JavaScript 以修改 `window.wallpaperPropertyListener` 时，常因环境不匹配或时序问题而静默失败。
- Wayland 的安全隔离机制进一步限制了跨进程通信。

**解决方案**：
- 如需修改 Web 壁纸属性，请尝试手动编辑壁纸的 `project.json` 或 HTML 源文件（需要一定的技术能力）。
- 优先选择属性较少或默认配置符合您需求的 Web 壁纸。

---

### ⚠️ 场景壁纸 (.pkg)

**兼容性**：有限支持

**可用功能**：
- ✅ 简单 2D/3D 场景：基础模型、纹理、光照
- ✅ 基础动画：时间轴动画、摄像机移动
- ⚠️ 基础粒子系统：简单的粒子可能正常工作

**已知问题**：
- ❌ **复杂粒子系统失效**：具有高级粒子效果的壁纸可能仅显示静态场景。
  - 症状：日志显示 `Particle system loaded` 但屏幕上看不到粒子。
  - 原因：粒子系统依赖于 Windows 特有的 DirectX API；OpenGL 转换可能不完整。
  
- ❌ **自定义着色器失效或出现异常**：使用 HLSL (DirectX 着色器语言) 的壁纸可能会遇到：
  - 效果缺失
  - 画面撕裂或视觉异常
  - 完全无法渲染（黑屏）
  - 原因：自动 HLSL 到 GLSL 的转换无法完全支持所有语法特性。

- ❌ **复杂脚本逻辑**：无法执行依赖于 Windows 特有 API 的交互脚本。

**推荐做法**：
- 下载前请查看创意工坊评论中 Linux 用户的反馈。
- 优先选择标记为“简单”或“低端”的场景壁纸。
- 避免使用描述中提到重度粒子效果或高级着色器的壁纸。

---

## Wayland 环境特别说明

如果您使用的是 Wayland 混成器/合成器 (Niri/Hyprland/Sway/GNOME Wayland)，请注意以下限制：

### ❌ 鼠标交互已完全禁用

**问题**：
- 无法显示鼠标轨迹 (Mouse Trails) 效果。
- 点击交互（例如点击切换场景、拖动对象）无响应。

**原因**：
- Wayland 的安全隔离要求应用程序必须获得焦点才能读取鼠标位置。
- 作为背景层运行的应用程序通常无法获取全局鼠标坐标。
- 即使在窗口模式下，某些依赖于 Windows 特有 API (`GetCursorPos`) 的交互脚本也无法工作。

**无解决方案**：这是架构层面的限制。

---

### ⚠️ OpenGL/GLX 兼容性问题

**症状**：
- 日志显示 `Failed to initialize GLEW: No GLX display`。
- 某些效果的渲染层级异常（例如粒子出现在模型后面）。
- Web 属性注入更容易失败。

**原因**：
- 某些旧版效果依赖于 GLX (OpenGL Extension for X11)。
- 纯 Wayland 环境缺乏 GLX，仅提供 EGL。

**解决方案**：
- 确保已安装 `xorg-xwayland`（大多数发行版默认安装）。
- 尝试在启动参数中添加环境变量（实验性）：
  ```bash
  GDK_BACKEND=x11 python3 run_gui.py
  ```

---

### ❌ Web 交互通信受限

**问题**：
- Web 壁纸的属性注入成功率较低。
- CEF 渲染偶尔会出现黑屏或闪烁。

**原因**：
- CEF 对 Wayland 的支持仍处于成熟阶段（依赖于 Ozone 层）。
- Wayland 下跨进程通信的时序问题更为严重。

**缓解措施**：
- 在“设置 > 高级”中，取消勾选“禁用鼠标交互”（虽然交互仍无法工作，但保留鼠标支持可能会提高 CEF 的稳定性）。
- 使用视频壁纸代替 Web 壁纸。

---

## X11 环境兼容性

**总体情况**：X11 的兼容性通常优于 Wayland。

**已知问题**：
- ⚠️ 某些桌面环境（如 XFCE/LXDE）可能无法正确设置壁纸层。
- ⚠️ 使用 Compton/Picom 等合成器时可能会出现撕裂。

**推荐桌面环境**：
- ✅ GNOME (X11)
- ✅ KDE Plasma (X11)
- ⚠️ i3/bspwm（需要手动配置窗口规则）

---

## 硬件兼容性

### GPU 要求

**最低配置**：
- 支持 OpenGL 3.3 的显卡
- 集成显卡 (Intel HD 4000+) 可运行简单壁纸

**推荐配置**：
- 独立显卡 (NVIDIA/AMD)
- 支持 OpenGL 4.5+

### 驱动问题

**NVIDIA**：
- ✅ 闭源驱动（推荐）：兼容性最佳
- ⚠️ Nouveau 开源驱动：性能较差，复杂场景可能卡顿

**AMD**：
- ✅ AMDGPU 驱动 (Mesa)：对现代显卡支持良好
- ⚠️ 旧款显卡可能缺少某些 OpenGL 扩展

**Intel**：
- ✅ Mesa 驱动：集成显卡支持基础功能
- ⚠️ 复杂场景壁纸可能性能不足

---

## 多显示器支持兼容性

**当前状态**：Beta 测试支持

**已知问题**：
- ⚠️ 断开连接的屏幕上的壁纸必须手动停止（GUI 会自动清理配置）。
- ⚠️ 刷新率不同的显示器可能会导致 FPS 不一致。
- ⚠️ 壁纸缩放可能在旋转（纵向）屏幕上出现异常。

---

## 性能与内存

### 预期资源占用

| 壁纸类型 | 内存占用 | CPU 占用 (30fps) | GPU 占用 |
|---------|---------|-----------------|---------|
| 视频 (1080p) | ~100MB | 5-10% | 低 |
| Web (简单) | ~200MB | 10-20% | 中低 |
| 场景 (简单) | ~150MB | 10-15% | 中 |
| 场景 (复杂) | ~300MB | 20-40% | 高 |

### 已知内存泄漏

**症状**：
- 长时间运行（8 小时以上）的 Web 壁纸可能会导致内存缓慢增长。
- 占用量最终可能达到 500MB - 1GB。

**原因**：
- 可能源于 CEF (Chromium 引擎) 的内存管理问题。
- 也可能是 C++ 后端或 Python 绑定的泄漏。

**临时解决方案**：
- 在“设置 > 自动化”中启用“定时轮换”以强制后端定期重启。
- 使用系统 crontab 定期执行 `python3 run_gui.py --stop && python3 run_gui.py --apply-last`。
- 避免长期使用复杂的 Web 壁纸。

---

## 测试环境

本项目主要在以下环境下开发和测试：

**主要测试环境**：
- 发行版：Arch Linux
- 窗口管理器：Niri (Wayland)
- GPU：Intel Iris Xe

**有限测试**：
- GNOME (Wayland/X11) ~计划中~

**未测试**：
- Ubuntu/Debian 系统
- 其他 Wayland 混成器/合成器（如 River/Labwc）
- 其他桌面环境（如 XFCE/Cinnamon）

如果您在其他环境下遇到问题，请提交 Issue 并附带详细的环境信息。

---

## 浅色/深色主题自适应支持 (v0.10.5)

从 v0.10.5 开始，应用程序现在可以使用 GTK 命名颜色无缝适应浅色和深色系统主题。这消除了之前的“仅限深色模式”限制，确保无论您的系统主题设置如何，所有文本、按钮和 UI 元素都保持完美的可读性。

---

## 获取帮助

如果您遇到兼容性问题，请提供以下信息：

1. 发行版及版本 (`cat /etc/os-release`)
2. 桌面环境 / 窗口管理器
3. 显示服务器 (X11/Wayland)
4. GPU 及驱动版本 (`glxinfo | grep OpenGL`)
5. 壁纸 ID 及类型
6. 日志输出（设置 > 日志页面）

在 GitHub Issues 页面提交问题：[https://github.com/Suhoiyis/gui-for-linux-wallpaperengine/issues](https://github.com/Suhoiyis/gui-for-linux-wallpaperengine/issues)
